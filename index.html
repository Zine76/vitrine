<!DOCTYPE html>

<html lang="fr">
<head>
<!-- VITRINE LOCK EARLY (prevents F5 landing) -->



<!-- API BASE PATCH v6: ultra-robuste (file://, '/api', 'api/', URLs file/null, Request & XHR) -->


<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Vitrine</title>
<!-- Favicon -->
<link href="https://zine76.github.io/vitrine/assets/Vitrine.png" rel="icon" type="image/png"/>
<!-- Font Awesome pour les icônes -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="style.css" rel="stylesheet"/>
<!-- Bannière mince d'accueil du chat -->
<link href="chat-welcome.css" rel="stylesheet"/>
<!-- Barre latérale de liens utiles -->
<link href="sidebar.css" rel="stylesheet"/>
<!-- Système d'appel WebRTC -->
<link href="call.css" rel="stylesheet"/>
</head>
<body class="">
<!-- Backend selector modal (IP dynamic) -->
<div id="backendModal" class="technical-auth-modal" style="display:none;">
    <div class="technical-auth-content" style="max-width:520px;">
        <h3><i class="fas fa-server"></i> Backend</h3>
        <p class="tech-auth-intro">Entrez l'adresse IP ou le nom d'hôte (ex: localhost ou SAV-ATL-POR-8.ddns.uqam.ca). Le port 7070 sera utilisé automatiquement si absent.</p>
        <div id="networkDetectionInfo" style="margin: 10px 0; padding: 8px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 4px; font-size: 0.85rem; display: none;">
            <strong>🌐 Détection automatique :</strong> <span id="networkDetectionText">En cours...</span>
        </div>
        <input type="text" id="backendIpInput" class="technical-password-input" placeholder="IP ou nom d'hôte du backend" aria-label="IP ou nom d'hôte du backend"/>
        <div class="technical-auth-buttons">
            <button class="technical-auth-btn technical-auth-cancel" onclick="window.hideBackendModal()">Annuler</button>
            <button class="technical-auth-btn technical-auth-submit" onclick="window.saveBackendIp()"><i class="fas fa-save"></i> Enregistrer</button>
        </div>
    </div>
    <div style="margin-top:8px; text-align:center; color:#64748b; font-size:0.85rem;">Cette configuration est temporaire jusqu'à l'IP fixe.</div>
</div>
<!-- Barre latérale de liens utiles -->
<div class="sidebar-links">
    <div class="sidebar-header">
        <h3>Liens Utiles</h3>
    </div>
    <div class="sidebar-buttons">
        <a href="https://audiovisuel.uqam.ca/formulaires/demande-dassistance-en-salle-de-classe/" target="_blank" rel="noopener" class="sidebar-btn" title="Service de l'audiovisuel UQAM">
            <div class="sidebar-icon">
                <i class="fas fa-video"></i>
            </div>
            <span>Audiovisuel UQAM</span>
        </a>
        
        <a href="https://enseigner.uqam.ca/rediffusion-formations/" target="_blank" rel="noopener" class="sidebar-btn" title="Formations pédagogiques">
            <div class="sidebar-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <span>Formations</span>
        </a>
        
        <a href="https://servicesinformatiques.uqam.ca/" target="_blank" rel="noopener" class="sidebar-btn" title="Services informatiques UQAM">
            <div class="sidebar-icon">
                <i class="fas fa-laptop-code"></i>
            </div>
            <span>Services Info</span>
        </a>
        
        <a href="https://sps.uqam.ca/" target="_blank" rel="noopener" class="sidebar-btn emergency" title="Sécurité et prévention - URGENCE">
            <div class="sidebar-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <span>Urgence SPS</span>
        </a>
    </div>
</div>

<!-- Container principal -->
<div class="main-container">
<!-- Header -->
<div class="header">
<div class="header-top">
<button class="technical-btn" onclick="openTechnicalMode()">
<i class="fas fa-cog"></i>
<span>Technique</span>
</button>
<button aria-label="Basculer le mode sombre" class="theme-toggle" onclick="toggleTheme()">
<i class="fas fa-moon" id="themeIcon"></i>
<span id="themeText">Mode nuit</span>
</button>
</div>
<div class="title-section">
<img alt="Vitrine" src="https://zine76.github.io/vitrine/assets/Vitrine.png" class="vitrine-logo"/>
<p id="headerTitle" class="header-title">Diagnostic interactif et assistance audiovisuelle</p>
</div>
<div class="status-indicator">
<div class="status-dot"></div>
<span>Système opérationnel</span>
</div>
</div>
<!-- Landing Page - Saisie de salle obligatoire -->
<div class="landing-page" id="landingPage">
<div class="landing-content">
<div class="room-input-banner">
<div class="banner-header">
<span class="banner-icon">📍</span>
<h3>Quelle salle avez-vous besoin d'aide ?</h3>
</div>
<div class="banner-content">
<p>Entrez le numéro de votre salle pour accéder à l'assistant personnalisé</p>
<div class="room-input-container">
<input class="room-input" id="roomInput" onkeypress="handleRoomKeyPress(event)" placeholder="Ex: A-1750, B-2500, SH-R200..." type="text" aria-label="Numéro de salle"/>
<button class="confirm-room-btn" id="confirmRoomBtn" onclick="confirmRoom()">
                                ✅ Confirmer
                            </button>
</div>
<div class="room-examples">
<p><strong>Exemples de formats acceptés :</strong></p>
<div class="example-rooms">
<span class="room-example" onclick="setRoomExample('A-1750')">A-1750</span>
<span class="room-example" onclick="setRoomExample('B-2500')">B-2500</span>
<span class="room-example" onclick="setRoomExample('J-2430')">J-2430</span>
<span class="room-example" onclick="setRoomExample('SH-R200')">SH-R200</span>
<span class="room-example" onclick="setRoomExample('DS-4000')">DS-4000</span>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Assistant Page - Affiché après validation de la salle -->
<div class="content hidden" id="assistantPage" role="region" aria-label="Assistant audiovisuel">
<!-- Header de salle -->
<div class="room-header" id="roomHeader">
<div class="current-room-info">
<span class="room-icon">📍</span>
<span class="room-text">Salle : <strong id="currentRoomDisplay">-</strong></span>
<button class="change-room-btn" onclick="changeRoom()" title="Changer de salle" aria-label="Changer de salle">
<i class="fas fa-edit"></i>
</button>
</div>
<!-- ✅ SUPPRIMÉ : Boutons inutiles Mode nuit et Accueil dans la zone de salle -->
</div>
<!-- Champ de saisie caché pour les messages -->
<input id="problemInput" class="hidden" type="hidden" aria-hidden="true"/>
<!-- Section des palettes de problèmes -->
<div class="problem-palettes" id="problemPalettes">
<!-- Palette Audio -->
<div class="palette audio" onclick="sendExampleMessage('Pas de son')">
<div class="palette-icon">🔵</div>
<h3>Problème Audio</h3>
<p>Microphones, haut-parleurs, volume, qualité sonore</p>
</div>
<!-- Palette Vidéo -->
<div class="palette video" onclick="sendExampleMessage('Écran noir projecteur')">
<div class="palette-icon">🟣</div>
<h3>Problème Vidéo</h3>
<p>Projecteurs, écrans, qualité d'image, connectivité</p>
</div>
<!-- Palette Réseau -->
<div class="palette network" onclick="sendExampleMessage('Problème de réseau')">
<div class="palette-icon">🟠</div>
<h3>Problème Réseau</h3>
<p>Connexion internet, Wi-Fi, connectivité réseau</p>
</div>
<!-- Palette Autres -->
<div class="palette other" onclick="sendExampleMessage('Système qui ne répond plus')">
<div class="palette-icon">🟢</div>
<h3>Autres Problèmes</h3>
<p>Équipements, infrastructure, maintenance générale</p>
</div>
</div>
<!-- Section des suggestions -->
<div class="suggestions" id="suggestions"></div>
</div>
</div>
<!-- Modale de résultat -->
<div class="modal-overlay" id="modalOverlay">
<div class="modal" id="modal">
<div class="modal-icon" id="modalIcon">✅</div>
<h3 id="modalTitle">Problème résolu</h3>
<p id="modalMessage">Le problème a été corrigé automatiquement.</p>
<button class="modal-btn" onclick="closeModal()">Retour à l'accueil</button>
</div>
</div>

<!-- Chat SEA Modal -->
<div class="chat-modal" id="chatModal">
<div class="chat-container">
<div class="chat-header">
<h3>💬 Chat SEA - Assistance en direct</h3>
<div class="chat-header-actions">
<div class="chat-font-controls">
<button class="chat-font-btn" onclick="adjustVitrineFont('decrease')" title="Réduire la taille du texte">
<i class="fas fa-search-minus"></i>
</button>
<span class="chat-font-size-indicator" id="vitrineFontIndicator">0%</span>
<button class="chat-font-btn" onclick="adjustVitrineFont('increase')" title="Augmenter la taille du texte">
<i class="fas fa-search-plus"></i>
</button>
</div>
<button class="chat-close" onclick="closeChat()" aria-label="Fermer le chat" title="Fermer le chat">
<i class="fas fa-times"></i>
</button>
</div>
</div>
<div class="chat-content" id="chatContent">
<div class="chat-messages" id="chatMessages"></div>
<div class="chat-input-area">
<textarea id="chatInput" placeholder="Tapez votre message..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage(); }" oninput="autoResizeTextarea(this); handleTypingVitrine(event);" aria-label="Message à envoyer"></textarea>
<button onclick="sendChatMessage()" class="send-btn" aria-label="Envoyer" title="Envoyer">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>
</div>
</div>

<!-- Consent Banner Centrée avec Animation Sonnerie -->
<div class="consent-banner hidden" id="consentBanner">
    <div class="consent-content">
        <!-- Icône chat qui clignote comme une notification -->
        <div class="consent-banner-phone">
            <i class="fas fa-comments fa-3x"></i>
        </div>
        
        <div class="consent-text">
            <h4>💬 Demande de chat SEA</h4>
            <p>Le service SEA souhaite établir un chat pour assister avec le ticket <strong id="consentTicketNumber">-</strong></p>
            <p><em>Demande de chat pour salle <span id="consentRoomName">-</span></em></p>
        </div>
        
        <div class="consent-actions">
            <button class="consent-btn accept" onclick="acceptChat()">
                <i class="fas fa-check"></i>
                Accepter
            </button>
            <button class="consent-btn decline" onclick="declineChat()">
                <i class="fas fa-times"></i>
                Refuser
            </button>
        </div>
    </div>
</div>

<!-- Chat Timeout Banner -->
<div class="chat-timeout-banner hidden" id="chatTimeoutBanner">
    <h3>
        <i class="fas fa-clock"></i>
        Demande de chat expirée
    </h3>
    <p>Le technicien SEA était disponible pour discuter de votre problème, mais le délai de réponse a expiré.</p>
    <p><strong>Souhaitez-vous initier une conversation avec le technicien ?</strong></p>
    
    <div class="timeout-actions">
        <button class="timeout-btn initiate" onclick="initiateRecallRequest()">
            <i class="fas fa-comments"></i>
            Contacter le SEA
        </button>
        <button class="timeout-btn close" onclick="closeTimeoutBannerWithDecline()">
            <i class="fas fa-times"></i>
            Fermer
        </button>
    </div>
</div>


<!-- Fonction globale supprimée - utilisation de createTicketDirect -->



<!-- VITRINE LOCK ENFORCER -->


<!-- ✅ NOUVEAU : Overlay de chargement diagnostic -->
<div id="diagnosticLoadingOverlay" class="diagnostic-loading-overlay">
    <div class="diagnostic-loading-content">
        <div class="diagnostic-hourglass">
            <i class="fas fa-hourglass-half"></i>
        </div>
        <div class="diagnostic-loading-text">Diagnostic en cours...</div>
        <p class="diagnostic-loading-subtext">Vérification automatique du système</p>
    </div>
</div>

<!-- ✅ NOUVEAU : Modal d'authentification technique -->
<div id="technicalAuthModal" class="technical-auth-modal">
    <div class="technical-auth-content">
        <h3>
            <i class="fas fa-lock"></i>
            Accès Technique
        </h3>
        <p class="tech-auth-intro">Veuillez saisir le mot de passe technique pour accéder au mode avancé.</p>
        <input 
            type="password" 
            id="technicalPassword" 
            class="technical-password-input" 
            placeholder="Mot de passe technique"
            aria-label="Mot de passe technique"
            onkeypress="handleTechnicalPasswordKeypress(event)"
        />
        <div class="technical-auth-error" id="technicalAuthError">
            Mot de passe incorrect. Veuillez réessayer.
        </div>
        <div class="technical-auth-buttons">
            <button class="technical-auth-btn technical-auth-cancel" onclick="closeTechnicalAuth()">
                Annuler
            </button>
            <button class="technical-auth-btn technical-auth-submit" onclick="submitTechnicalAuth()">
                <i class="fas fa-unlock"></i>
                Accéder
            </button>
        </div>
    </div>
</div>

<!-- ✅ NOUVEAU : Page technique -->
<div id="technicalPage" class="technical-page">
    <div class="technical-header">
        <div class="technical-title">
            <i class="fas fa-cog"></i>
            <h2>Mode Technique</h2>
        </div>
        <button class="technical-return-btn" onclick="returnToVitrine()" aria-label="Retour à Vitrine">
            <i class="fas fa-arrow-left"></i>
            Retour à Vitrine
        </button>
    </div>
    <div class="technical-content">
        <div class="technical-construction-banner">
            <h3>
                <i class="fas fa-hard-hat"></i>
                Page en Construction
            </h3>
            <p>Cette section technique est actuellement en développement. Les plans unifilaires et autres outils techniques seront bientôt disponibles.</p>
        </div>
        
        <!-- ✅ NOUVEAU : Section Plans Unifilaires avec lien PDF -->
        <div class="card card--spaced">
            <h4 class="card-title with-icon">
                <i class="fas fa-blueprint"></i>
                Plans Unifilaires
            </h4>
            <div class="technical-room-info">
                <p><strong>Salle actuelle :</strong> <span id="technicalCurrentRoom">-</span></p>
                <div id="technicalPlanSection" class="technical-plan-section" style="display: none;">
                    <div class="plan-info">
                        <i class="fas fa-file-pdf"></i>
                        <span>Plan unifilaire disponible pour cette salle</span>
                    </div>
                    <a id="technicalPlanLink" 
                       href="#" 
                       target="_blank" 
                       class="technical-plan-btn"
                       title="Ouvrir le plan unifilaire dans un nouvel onglet">
                        <i class="fas fa-external-link-alt"></i>
                        Ouvrir le Plan Unifilaire
                    </a>
                </div>
                <div id="technicalNoPlan" class="technical-no-plan" style="display: block;">
                    <i class="fas fa-info-circle"></i>
                    <em>Aucun plan unifilaire disponible pour cette salle actuellement.</em>
                </div>
            </div>
        </div>

        <!-- Section future pour autres outils -->
        <div class="card">
            <h4 class="card-title with-icon">
                <i class="fas fa-tools"></i>
                Outils Techniques
            </h4>
            <p class="text-muted m-0">
                <em>Diagnostic avancé, gestion réseau, et autres outils techniques seront disponibles ici.</em>
            </p>
        </div>
    </div>
</div>

<!-- Force assets to use GitHub Pages directory -->
<script>window.ASSETS_BASE = 'https://zine76.github.io/vitrine/assets';</script>
<script>
// Backend base handling
(function(){
  function isValidHost(input){
    try{
      var v = String(input||'').trim();
      if (!v) return false;
      if (/^https?:\/\//i.test(v)) return true; // URL complète
      if (/^\d{1,3}(?:\.\d{1,3}){3}$/.test(v)) return true; // IPv4
      if (/^[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)+$/.test(v)) return true; // domaine/hostname
      return false;
    }catch(e){ return false; }
  }
  window.showBackendModal = function(prefill){
    var m = document.getElementById('backendModal');
    if (!m) return; m.style.display='block';
    window.__backendPromptOpen = true;
    var inp = document.getElementById('backendIpInput');
    if (inp){ inp.value = (prefill||'').toString(); setTimeout(function(){ inp.focus(); inp.select(); }, 50); }
    
    // Afficher les informations de détection réseau si disponibles
    var networkInfo = document.getElementById('networkDetectionInfo');
    var networkText = document.getElementById('networkDetectionText');
    if (networkInfo && networkText) {
      if (typeof currentAPI !== 'undefined' && currentAPI) {
        networkInfo.style.display = 'block';
        networkText.textContent = 'Backend actuel: ' + currentAPI;
      } else {
        networkInfo.style.display = 'none';
      }
    }
  };
  window.hideBackendModal = function(){ var m = document.getElementById('backendModal'); if(m) m.style.display='none'; window.__backendPromptOpen = false; };
  window.saveBackendIp = function(){
    var raw = (document.getElementById('backendIpInput')||{}).value||'';
    if (!isValidHost(raw)){
      alert('Valeur invalide. Entrez une IP (ex: localhost), un nom d\'hôte (ex: host.domaine), ou une URL http(s) complète.');
      return;
    }
    var value = raw.trim();
    try{ localStorage.setItem('vitrine.backend.ip', value); }catch(e){}
    var base = /^https?:\/\//i.test(value) ? value : ('http://' + value + ':7070');
    window.BACKEND_BASE = base;
    window.dispatchEvent(new CustomEvent('backend:updated', { detail: { base } }));
    window.hideBackendModal();
  };
  
  // Raccourci Alt+Ctrl+J pour ouvrir la configuration avec rotation des IPs
  document.addEventListener('keydown', function(e){
    if (e.altKey && e.ctrlKey && (e.key === 'j' || e.key === 'J' || e.code === 'KeyJ')){
      e.preventDefault();
      e.stopPropagation();
      
      // Exemples d'IPs disponibles avec labels (pour suggestions uniquement)
      var IPS_WITH_LABELS = [
        { ip: 'localhost', label: 'Local (Même PC)' },
        { ip: '', label: 'Entrer IP manuellement' },
        { ip: 'SAV-ATL-POR-8.ddns.uqam.ca', label: 'DNS UQAM' }
      ];
      
      // Récupérer l'IP actuelle
      var currentIp = localStorage.getItem('vitrine.backend.ip') || '';
      
      // Trouver l'index actuel
      var currentIndex = IPS_WITH_LABELS.findIndex(function(item) { return item.ip === currentIp; });
      if (currentIndex === -1) currentIndex = 0;
      
      // Passer à la prochaine IP (rotation)
      var nextIndex = (currentIndex + 1) % IPS_WITH_LABELS.length;
      var nextIpConfig = IPS_WITH_LABELS[nextIndex];
      
      // Afficher dans la console pour info
      console.log('🔄 [IP Switch] ' + currentIp + ' → ' + nextIpConfig.ip + ' (' + nextIpConfig.label + ')');
      
      // Ouvrir le modal avec la nouvelle IP
      window.showBackendModal(nextIpConfig.ip);
    }
  }, true);
  // Première ouverture: si aucune IP stockée et si on n'est pas en prod fixe
  document.addEventListener('DOMContentLoaded', function(){
    try{
      // Nettoyer les verrous corrompus (IP stockées comme salle)
      var lockData = localStorage.getItem('vitrine.room.lock');
      if (lockData) {
        var parsed = JSON.parse(lockData);
        if (parsed && parsed.name && /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(parsed.name)) {
          console.log('[CleanBadLock] IP détectée comme salle, suppression:', parsed.name);
          localStorage.removeItem('vitrine.room.lock');
          location.reload(); // Recharger pour appliquer
          return;
        }
      }
      
      // ✅ CORRECTION EXPERT : Retour au système DNS normal (pas de localhost forcé)
      console.log('🌐 [Backend] Utilisation du système DNS normal pour multi-PC');
    }catch(e){
      console.error('❌ [Backend] Erreur initialisation:', e);
    }

    // Raccourci clavier pour rouvrir la bannière backend
    document.addEventListener('keydown', function(ev){
      try{
        if (ev.altKey && ev.ctrlKey && (ev.key === 'j' || ev.key === 'J')){
          ev.preventDefault();
          var currentIp = localStorage.getItem('vitrine.backend.ip') || '';
          window.showBackendModal(currentIp);
        }
      }catch(e){}
    });
  });
})();
</script>
<!-- Module des plans unifilaires - Depuis GitHub -->
<script src="room-plans.js"></script>
<script src="app.js"></script>
<script>
// ✅ CONFIGURATION INTELLIGENTE AVEC IPs MULTIPLES
console.log('🔧 [Config] Système multi-IP avec Alt+Ctrl+J');

// Configuration des IPs disponibles (incluant UQAM pour Podio)
const AVAILABLE_IPS = []; // Pas d'IPs par défaut - utiliser Alt+Ctrl+J pour configurer

// Vérifier si une IP est déjà configurée, sinon utiliser la première disponible
setTimeout(function() {
    var storedIp = localStorage.getItem('vitrine.backend.ip');
    
    if (storedIp) {
        console.log('✅ [Config] IP existante trouvée:', storedIp);
        
        // S'assurer que le BACKEND_BASE est bien configuré au chargement
        if (typeof window !== 'undefined') {
            window.BACKEND_BASE = 'http://' + storedIp + ':7070';
        }
    } else {
        console.log('⚠️ [Config] Aucune IP configurée. Utilisez Alt+Ctrl+J pour configurer le backend.');
    }
}, 100);

// Info pour l'utilisateur
console.log('💡 [Info] Utilisez Alt+Ctrl+J pour configurer l\'adresse du backend');
console.log('   Exemples: localhost, votre-ip-locale, SAV-ATL-POR-8.ddns.uqam.ca');
console.log('   Pour connaître votre IP locale: ipconfig (Windows) ou ifconfig (Linux/Mac)');
</script>
<!-- Tout le JavaScript a été déplacé dans app.js -->
<!-- Système d'appel WebRTC -->
<script src="call.js"></script>
</body>
</html> 