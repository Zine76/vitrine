<!DOCTYPE html>

<html lang="fr">
<head>
<!-- VITRINE LOCK EARLY (prevents F5 landing) -->



<!-- API BASE PATCH v6: ultra-robuste (file://, '/api', 'api/', URLs file/null, Request & XHR) -->


<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Vitrine</title>
<!-- Favicon -->
<link href="https://zine76.github.io/vitrine/assets/Vitrine.png" rel="icon" type="image/png"/>
<!-- Font Awesome pour les ic�nes -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="style.css" rel="stylesheet"/>
<!-- Banni�re mince d'accueil du chat -->
<link href="chat-welcome.css" rel="stylesheet"/>
<!-- Barre lat�rale de liens utiles -->
<link href="sidebar.css" rel="stylesheet"/>
<link href="graphSearch.css" rel="stylesheet"/>
<!-- Syst�me d'appel WebRTC -->
<!-- call.css SUPPRIMÉ - Vitrine ne fait plus d'appels -->
<style id="modal-inline-css">
/* Modal Equipment - Styles inline pour file:/// */
#equipmentModal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: 99999 !important;
    background: rgba(0,0,0,0.7) !important;
    display: none;
    align-items: center !important;
    justify-content: center !important;
}
#equipmentModal .equipment-modal-content {
    position: relative !important;
    background: white !important;
    border-radius: 12px !important;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5) !important;
    max-width: 700px !important;
    width: 90% !important;
    max-height: 85vh !important;
    overflow: auto !important;
    z-index: 100000 !important;
    padding: 20px !important;
}
#equipmentModal .equipment-modal-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    border-bottom: 1px solid #eee !important;
    padding-bottom: 15px !important;
    margin-bottom: 15px !important;
}
#equipmentModal .equipment-modal-close {
    background: #f44336 !important;
    color: white !important;
    border: none !important;
    border-radius: 50% !important;
    width: 32px !important;
    height: 32px !important;
    cursor: pointer !important;
    font-size: 16px !important;
}

/* ===== EQUIPEMENT VISUEL - DESIGN PROFESSIONNEL ===== */
.eq-visual-container {
    padding: 10px;
}

.eq-block {
    display: flex;
    border: 3px solid #333;
    border-radius: 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* Colonnes des ports */
.eq-ports {
    min-width: 180px;
    padding: 15px 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.eq-ports-in {
    background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
    border-right: 2px solid #1976d2;
}

.eq-ports-out {
    background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 100%);
    border-left: 2px solid #388e3c;
}

.eq-ports-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    padding-bottom: 5px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.eq-ports-in .eq-ports-label {
    color: #1565c0;
}

.eq-ports-out .eq-ports-label {
    color: #2e7d32;
}

/* Ports individuels */
.eq-port {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    background: rgba(255,255,255,0.7);
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
}

.eq-port-in {
    flex-direction: row;
}

.eq-port-out {
    flex-direction: row-reverse;
}

.eq-port-connector {
    font-size: 14px;
}

.eq-port-in .eq-port-connector {
    color: #1976d2;
}

.eq-port-out .eq-port-connector {
    color: #388e3c;
}

.eq-port-name {
    color: #333;
    white-space: nowrap;
}

.eq-port-none {
    font-size: 10px;
    color: #999;
    font-style: italic;
}

/* Corps de l equipement */
.eq-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px 30px;
    min-width: 300px;
    background: linear-gradient(135deg, #37474f 0%, #263238 100%);
    color: white;
    text-align: center;
    min-width: 200px;
}

.eq-brand {
    font-size: 16px;
    font-weight: 600;
    color: #4fc3f7;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
}

.eq-model {
    font-size: 28px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 8px;
}

.eq-function {
    font-size: 11px;
    color: #b0bec5;
    max-width: 180px;
    line-height: 1.4;
}

/* Legende */
.eq-legend {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.eq-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: #666;
}

.eq-legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.eq-legend-in {
    background: #1976d2;
}

.eq-legend-out {
    background: #388e3c;
}
/* Code cable sur les ports */
.eq-port-cable {
    background: #ff9800;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    font-family: 'Consolas', 'Monaco', monospace;
    margin-left: 8px;
}

.eq-port-out .eq-port-cable {
    margin-left: 0;
    margin-right: 8px;
}

/* Agrandir les ports */
.eq-port {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.8);
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
}

.eq-port-name {
    color: #333;
    white-space: nowrap;
    flex: 1;
}

.eq-port-connector {
    font-size: 16px;
}
</style>
</head>
<body class="">
<!-- Backend selector modal (IP dynamic) -->
<div id="backendModal" class="technical-auth-modal" style="display:none;">
    <div class="technical-auth-content" style="max-width:520px;">
        <h3><i class="fas fa-server"></i> Backend</h3>
        <p class="tech-auth-intro">Entrez l'adresse IP ou le nom d'h�te (ex: localhost ou SAV-ATL-POR-8.ddns.uqam.ca). Le port 7070 sera utilis� automatiquement si absent.</p>
        <div id="networkDetectionInfo" style="margin: 10px 0; padding: 8px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 4px; font-size: 0.85rem; display: none;">
            <strong>?? D�tection automatique :</strong> <span id="networkDetectionText">En cours...</span>
        </div>
        <input type="text" id="backendIpInput" class="technical-password-input" placeholder="IP ou nom d'h�te du backend" aria-label="IP ou nom d'h�te du backend"/>
        <div class="technical-auth-buttons">
            <button class="technical-auth-btn technical-auth-cancel" onclick="window.hideBackendModal()">Annuler</button>
            <button class="technical-auth-btn technical-auth-submit" onclick="window.saveBackendIp()"><i class="fas fa-save"></i> Enregistrer</button>
        </div>
    </div>
    <div style="margin-top:8px; text-align:center; color:#64748b; font-size:0.85rem;">Cette configuration est temporaire jusqu'� l'IP fixe.</div>
</div>
<!-- Barre lat�rale de liens utiles -->
<div class="sidebar-links">
    <div class="sidebar-header">
        <h3>Liens Utiles</h3>
    </div>
    <div class="sidebar-buttons">
        <a href="https://audiovisuel.uqam.ca/formulaires/demande-dassistance-en-salle-de-classe/" target="_blank" rel="noopener" class="sidebar-btn" title="Service de l'audiovisuel UQAM">
            <div class="sidebar-icon">
                <i class="fas fa-video"></i>
            </div>
            <span>Audiovisuel UQAM</span>
        </a>
        
        <a href="https://enseigner.uqam.ca/rediffusion-formations/" target="_blank" rel="noopener" class="sidebar-btn" title="Formations p�dagogiques">
            <div class="sidebar-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <span>Formations</span>
        </a>
        
        <a href="https://servicesinformatiques.uqam.ca/" target="_blank" rel="noopener" class="sidebar-btn" title="Services informatiques UQAM">
            <div class="sidebar-icon">
                <i class="fas fa-laptop-code"></i>
            </div>
            <span>Services Info</span>
        </a>
        
        <a href="https://sps.uqam.ca/" target="_blank" rel="noopener" class="sidebar-btn emergency" title="S�curit� et pr�vention - URGENCE">
            <div class="sidebar-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <span>Urgence SPS</span>
        </a>
    </div>
</div>

<!-- Container principal -->
<div class="main-container">
<!-- Header -->
<div class="header">
<div class="header-top">
<button class="technical-btn" onclick="openTechnicalMode()">
<i class="fas fa-cog"></i>
<span>Technique</span>
</button>
<button aria-label="Basculer le mode sombre" class="theme-toggle" onclick="toggleTheme()">
<i class="fas fa-moon" id="themeIcon"></i>
<span id="themeText">Mode nuit</span>
</button>
</div>
<div class="title-section">
<img alt="Vitrine" src="https://zine76.github.io/vitrine/assets/Vitrine.png" class="vitrine-logo"/>
<p id="headerTitle" class="header-title">Diagnostic interactif et assistance audiovisuelle</p>
</div>
<div class="status-indicator">
<div class="status-dot"></div>
<span>Syst�me op�rationnel</span>
</div>
</div>
<!-- Landing Page - Saisie de salle obligatoire -->
<div class="landing-page" id="landingPage">
<div class="landing-content">
<div class="room-input-banner">
<div class="banner-header">
<span class="banner-icon">??</span>
<h3>Quelle salle avez-vous besoin d'aide ?</h3>
</div>
<div class="banner-content">
<p>Entrez le num�ro de votre salle pour acc�der � l'assistant personnalis�</p>
<div class="room-input-container">
<input class="room-input" id="roomInput" onkeypress="handleRoomKeyPress(event)" placeholder="Ex: A-1750, B-2500, SH-R200..." type="text" aria-label="Num�ro de salle"/>
<button class="confirm-room-btn" id="confirmRoomBtn" onclick="confirmRoom()">
                                ? Confirmer
                            </button>
</div>
<div class="room-examples">
<p><strong>Exemples de formats accept�s :</strong></p>
<div class="example-rooms">
<span class="room-example" onclick="setRoomExample('A-1750')">A-1750</span>
<span class="room-example" onclick="setRoomExample('B-2500')">B-2500</span>
<span class="room-example" onclick="setRoomExample('J-2430')">J-2430</span>
<span class="room-example" onclick="setRoomExample('SH-R200')">SH-R200</span>
<span class="room-example" onclick="setRoomExample('DS-4000')">DS-4000</span>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Assistant Page - Affich� apr�s validation de la salle -->
<div class="content hidden" id="assistantPage" role="region" aria-label="Assistant audiovisuel">
<!-- Header de salle -->
<div class="room-header" id="roomHeader">
<div class="current-room-info">
<span class="room-icon">??</span>
<span class="room-text">Salle : <strong id="currentRoomDisplay">-</strong></span>
<button class="change-room-btn" onclick="changeRoom()" title="Changer de salle" aria-label="Changer de salle">
<i class="fas fa-edit"></i>
</button>
</div>
<!-- ? SUPPRIM� : Boutons inutiles Mode nuit et Accueil dans la zone de salle -->
</div>
<!-- Champ de saisie cach� pour les messages -->
<input id="problemInput" class="hidden" type="hidden" aria-hidden="true"/>
<!-- Section des palettes de probl�mes -->
<div class="problem-palettes" id="problemPalettes">
<!-- Palette Audio -->
<div class="palette audio" onclick="sendExampleMessage('Pas de son')">
<div class="palette-icon">??</div>
<h3>Probl�me Audio</h3>
<p>Microphones, haut-parleurs, volume, qualit� sonore</p>
</div>
<!-- Palette Vid�o -->
<div class="palette video" onclick="sendExampleMessage('�cran noir projecteur')">
<div class="palette-icon">??</div>
<h3>Probl�me Vid�o</h3>
<p>Projecteurs, �crans, qualit� d'image, connectivit�</p>
</div>
<!-- Palette R�seau -->
<div class="palette network" onclick="sendExampleMessage('Probl�me de r�seau')">
<div class="palette-icon">??</div>
<h3>Probl�me R�seau</h3>
<p>Connexion internet, Wi-Fi, connectivit� r�seau</p>
</div>
<!-- Palette Autres -->
<div class="palette other" onclick="sendExampleMessage('Syst�me qui ne r�pond plus')">
<div class="palette-icon">??</div>
<h3>Autres Probl�mes</h3>
<p>�quipements, infrastructure, maintenance g�n�rale</p>
</div>
</div>
<!-- Section des suggestions -->
<div class="suggestions" id="suggestions"></div>
</div>
</div>
<!-- Modale de r�sultat -->
<div class="modal-overlay" id="modalOverlay">
<div class="modal" id="modal">
<div class="modal-icon" id="modalIcon">?</div>
<h3 id="modalTitle">Probl�me r�solu</h3>
<p id="modalMessage">Le probl�me a �t� corrig� automatiquement.</p>
<button class="modal-btn" onclick="closeModal()">Retour � l'accueil</button>
</div>
</div>

<!-- Chat SEA Modal -->
<div class="chat-modal" id="chatModal">
<div class="chat-container">
<div class="chat-header">
<h3>?? Chat SEA - Assistance en direct</h3>
<div class="chat-header-actions">
<div class="chat-font-controls">
<button class="chat-font-btn" onclick="adjustVitrineFont('decrease')" title="R�duire la taille du texte">
<i class="fas fa-search-minus"></i>
</button>
<span class="chat-font-size-indicator" id="vitrineFontIndicator">0%</span>
<button class="chat-font-btn" onclick="adjustVitrineFont('increase')" title="Augmenter la taille du texte">
<i class="fas fa-search-plus"></i>
</button>
</div>
<button class="chat-close" onclick="closeChat()" aria-label="Fermer le chat" title="Fermer le chat">
<i class="fas fa-times"></i>
</button>
</div>
</div>
<div class="chat-content" id="chatContent">
<div class="chat-messages" id="chatMessages"></div>
<div class="chat-input-area">
<textarea id="chatInput" placeholder="Tapez votre message..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage(); }" oninput="autoResizeTextarea(this); handleTypingVitrine(event);" aria-label="Message � envoyer"></textarea>
<button onclick="sendChatMessage()" class="send-btn" aria-label="Envoyer" title="Envoyer">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>
</div>
</div>

<!-- Consent Banner Centr�e avec Animation Sonnerie -->
<div class="consent-banner hidden" id="consentBanner">
    <div class="consent-content">
        <!-- Ic�ne chat qui clignote comme une notification -->
        <div class="consent-banner-phone">
            <i class="fas fa-comments fa-3x"></i>
        </div>
        
        <div class="consent-text">
            <h4>?? Demande de chat SEA</h4>
            <p>Le service SEA souhaite �tablir un chat pour assister avec le ticket <strong id="consentTicketNumber">-</strong></p>
            <p><em>Demande de chat pour salle <span id="consentRoomName">-</span></em></p>
        </div>
        
        <div class="consent-actions">
            <button class="consent-btn accept" onclick="acceptChat()">
                <i class="fas fa-check"></i>
                Accepter
            </button>
            <button class="consent-btn decline" onclick="declineChat()">
                <i class="fas fa-times"></i>
                Refuser
            </button>
        </div>
    </div>
</div>

<!-- Chat Timeout Banner -->
<div class="chat-timeout-banner hidden" id="chatTimeoutBanner">
    <h3>
        <i class="fas fa-clock"></i>
        Demande de chat expir�e
    </h3>
    <p>Le technicien SEA �tait disponible pour discuter de votre probl�me, mais le d�lai de r�ponse a expir�.</p>
    <p><strong>Souhaitez-vous initier une conversation avec le technicien ?</strong></p>
    
    <div class="timeout-actions">
        <button class="timeout-btn initiate" onclick="initiateRecallRequest()">
            <i class="fas fa-comments"></i>
            Contacter le SEA
        </button>
        <button class="timeout-btn close" onclick="closeTimeoutBannerWithDecline()">
            <i class="fas fa-times"></i>
            Fermer
        </button>
    </div>
</div>


<!-- Fonction globale supprim�e - utilisation de createTicketDirect -->



<!-- VITRINE LOCK ENFORCER -->


<!-- ? NOUVEAU : Overlay de chargement diagnostic -->
<div id="diagnosticLoadingOverlay" class="diagnostic-loading-overlay">
    <div class="diagnostic-loading-content">
        <div class="diagnostic-hourglass">
            <i class="fas fa-hourglass-half"></i>
        </div>
        <div class="diagnostic-loading-text">Diagnostic en cours...</div>
        <p class="diagnostic-loading-subtext">V�rification automatique du syst�me</p>
    </div>
</div>

<!-- ? NOUVEAU : Modal d'authentification technique -->
<div id="technicalAuthModal" class="technical-auth-modal">
    <div class="technical-auth-content">
        <h3>
            <i class="fas fa-lock"></i>
            Acc�s Technique
        </h3>
        <p class="tech-auth-intro">Veuillez saisir le mot de passe technique pour acc�der au mode avanc�.</p>
        <input 
            type="password" 
            id="technicalPassword" 
            class="technical-password-input" 
            placeholder="Mot de passe technique"
            aria-label="Mot de passe technique"
            onkeypress="handleTechnicalPasswordKeypress(event)"
        />
        <div class="technical-auth-error" id="technicalAuthError">
            Mot de passe incorrect. Veuillez r�essayer.
        </div>
        <div class="technical-auth-buttons">
            <button class="technical-auth-btn technical-auth-cancel" onclick="closeTechnicalAuth()">
                Annuler
            </button>
            <button class="technical-auth-btn technical-auth-submit" onclick="submitTechnicalAuth()">
                <i class="fas fa-unlock"></i>
                Acc�der
            </button>
        </div>
    </div>
</div>

<!-- ? NOUVEAU : Page technique -->
<div id="technicalPage" class="technical-page">
    <div class="technical-header">
        <div class="technical-title">
            <i class="fas fa-cog"></i>
            <h2>Mode Technique</h2>
        </div>
        <button class="technical-return-btn" onclick="returnToVitrine()" aria-label="Retour � Vitrine">
            <i class="fas fa-arrow-left"></i>
            Retour � Vitrine
        </button>
    </div>
    <div class="technical-content">
        <div class="technical-construction-banner">
            <h3>
                <i class="fas fa-hard-hat"></i>
                Page en Construction
            </h3>
            <p>Cette section technique est actuellement en d�veloppement. Les plans unifilaires et autres outils techniques seront bient�t disponibles.</p>
        </div>
        
        <!-- ? NOUVEAU : Section Plans Unifilaires avec lien PDF -->
        <div class="card card--spaced">
            <h4 class="card-title with-icon">
                <i class="fas fa-blueprint"></i>
                Plans Unifilaires
            </h4>
            <div class="technical-room-info">
                <p><strong>Salle actuelle :</strong> <span id="technicalCurrentRoom">-</span></p>
                <div id="technicalPlanSection" class="technical-plan-section" style="display: none;">
                    <div class="plan-info">
                        <i class="fas fa-file-pdf"></i>
                        <span>Plan unifilaire disponible pour cette salle</span>
                    </div>
                    <a id="technicalPlanLink" 
                       href="#" 
                       target="_blank" 
                       class="technical-plan-btn"
                       title="Ouvrir le plan unifilaire dans un nouvel onglet">
                        <i class="fas fa-external-link-alt"></i>
                        Ouvrir le Plan Unifilaire
                    </a>
                </div>
                <div id="technicalNoPlan" class="technical-no-plan" style="display: block;">
                    <i class="fas fa-info-circle"></i>
                    <em>Aucun plan unifilaire disponible pour cette salle actuellement.</em>
                </div>
            </div>
        </div>

                <!-- Section Recherche de C�blage -->
        <div class="card card--spaced">
            <h4 class="card-title with-icon">
                <i class="fas fa-search"></i>
                Recherche de C�blage
            </h4>
            <div class="graph-search-container">
                <div class="search-input-wrapper">
                    <input 
                        type="text" 
                        id="graphSearchInput" 
                        class="graph-search-input" 
                        placeholder="Rechercher un c�ble (ex: V001) ou un �quipement (ex: Extron)"
                        aria-label="Recherche c�ble ou �quipement"
                        onkeyup="handleGraphSearch(event)"
                    />
                    <button class="graph-search-btn" onclick="executeGraphSearch()" title="Rechercher">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="graph-clear-btn" onclick="clearGraphSearch()" title="Effacer">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="graphSearchStats" class="graph-stats hidden">
                    <span class="stat-item"><i class="fas fa-cube"></i> <span id="statNodes">0</span> �quipements</span>
                    <span class="stat-item"><i class="fas fa-link"></i> <span id="statEdges">0</span> c�bles</span>
                    <span class="stat-item warning"><i class="fas fa-exclamation-triangle"></i> <span id="statUncertain">0</span> incertains</span>
                </div>
                
                <div id="graphSearchResults" class="graph-results">
                    <div class="graph-placeholder">
                        <i class="fas fa-project-diagram"></i>
                        <p>Entrez un code c�ble (ex: V001, A001) ou un nom d'�quipement (ex: Extron)</p>
                    </div>
                </div>
            </div>
        </div>
<!-- Section future pour autres outils -->
        <div class="card">
            <h4 class="card-title with-icon">
                <i class="fas fa-tools"></i>
                Outils Techniques
            </h4>
            <p class="text-muted m-0">
                <em>Diagnostic avanc�, gestion r�seau, et autres outils techniques seront disponibles ici.</em>
            </p>
        </div>
    </div>
</div>

<!-- Force assets to use GitHub Pages directory -->
<script>window.ASSETS_BASE = 'https://zine76.github.io/vitrine/assets';</script>
<script>
// Backend base handling
(function(){
  function isValidHost(input){
    try{
      var v = String(input||'').trim();
      if (!v) return false;
      if (/^https?:\/\//i.test(v)) return true; // URL compl�te
      if (/^\d{1,3}(?:\.\d{1,3}){3}$/.test(v)) return true; // IPv4
      if (/^[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)+$/.test(v)) return true; // domaine/hostname
      return false;
    }catch(e){ return false; }
  }
  window.showBackendModal = function(prefill){
    var m = document.getElementById('backendModal');
    if (!m) return; m.style.display='block';
    window.__backendPromptOpen = true;
    var inp = document.getElementById('backendIpInput');
    if (inp){ inp.value = (prefill||'').toString(); setTimeout(function(){ inp.focus(); inp.select(); }, 50); }
    
    // Afficher les informations de d�tection r�seau si disponibles
    var networkInfo = document.getElementById('networkDetectionInfo');
    var networkText = document.getElementById('networkDetectionText');
    if (networkInfo && networkText) {
      if (typeof currentAPI !== 'undefined' && currentAPI) {
        networkInfo.style.display = 'block';
        networkText.textContent = 'Backend actuel: ' + currentAPI;
      } else {
        networkInfo.style.display = 'none';
      }
    }
  };
  window.hideBackendModal = function(){ var m = document.getElementById('backendModal'); if(m) m.style.display='none'; window.__backendPromptOpen = false; };
  window.saveBackendIp = function(){
    var raw = (document.getElementById('backendIpInput')||{}).value||'';
    if (!isValidHost(raw)){
      alert('Valeur invalide. Entrez une IP (ex: localhost), un nom d\'h�te (ex: host.domaine), ou une URL http(s) compl�te.');
      return;
    }
    var value = raw.trim();
    try{ localStorage.setItem('vitrine.backend.ip', value); }catch(e){}
    var base = /^https?:\/\//i.test(value) ? value : ('http://' + value + ':7070');
    window.BACKEND_BASE = base;
    window.dispatchEvent(new CustomEvent('backend:updated', { detail: { base } }));
    window.hideBackendModal();
  };
  
  // Raccourci Alt+Ctrl+J pour ouvrir la configuration avec rotation des IPs
  document.addEventListener('keydown', function(e){
    if (e.altKey && e.ctrlKey && (e.key === 'j' || e.key === 'J' || e.code === 'KeyJ')){
      e.preventDefault();
      e.stopPropagation();
      
      // Exemples d'IPs disponibles avec labels (pour suggestions uniquement)
      var IPS_WITH_LABELS = [
        { ip: 'localhost', label: 'Local (M�me PC)' },
        { ip: '', label: 'Entrer IP manuellement' },
        { ip: 'SAV-ATL-POR-8.ddns.uqam.ca', label: 'DNS UQAM' }
      ];
      
      // R�cup�rer l'IP actuelle
      var currentIp = localStorage.getItem('vitrine.backend.ip') || '';
      
      // Trouver l'index actuel
      var currentIndex = IPS_WITH_LABELS.findIndex(function(item) { return item.ip === currentIp; });
      if (currentIndex === -1) currentIndex = 0;
      
      // Passer � la prochaine IP (rotation)
      var nextIndex = (currentIndex + 1) % IPS_WITH_LABELS.length;
      var nextIpConfig = IPS_WITH_LABELS[nextIndex];
      
      // Afficher dans la console pour info
      console.log('?? [IP Switch] ' + currentIp + ' ? ' + nextIpConfig.ip + ' (' + nextIpConfig.label + ')');
      
      // Ouvrir le modal avec la nouvelle IP
      window.showBackendModal(nextIpConfig.ip);
    }
  }, true);
  // Premi�re ouverture: si aucune IP stock�e et si on n'est pas en prod fixe
  document.addEventListener('DOMContentLoaded', function(){
    try{
      // Nettoyer les verrous corrompus (IP stock�es comme salle)
      var lockData = localStorage.getItem('vitrine.room.lock');
      if (lockData) {
        var parsed = JSON.parse(lockData);
        if (parsed && parsed.name && /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(parsed.name)) {
          console.log('[CleanBadLock] IP d�tect�e comme salle, suppression:', parsed.name);
          localStorage.removeItem('vitrine.room.lock');
          location.reload(); // Recharger pour appliquer
          return;
        }
      }
      
      // ? CORRECTION EXPERT : Retour au syst�me DNS normal (pas de localhost forc�)
      console.log('?? [Backend] Utilisation du syst�me DNS normal pour multi-PC');
    }catch(e){
      console.error('? [Backend] Erreur initialisation:', e);
    }

    // Raccourci clavier pour rouvrir la banni�re backend
    document.addEventListener('keydown', function(ev){
      try{
        if (ev.altKey && ev.ctrlKey && (ev.key === 'j' || ev.key === 'J')){
          ev.preventDefault();
          var currentIp = localStorage.getItem('vitrine.backend.ip') || '';
          window.showBackendModal(currentIp);
        }
      }catch(e){}
    });
  });
})();
</script>
<!-- Module des plans unifilaires - Depuis GitHub -->
<script src="room-plans.js"></script>
<script src="graphSearch.js"></script>
<script src="app.js"></script>
<!-- Room Brain Integration V1.1 - Diagnosis First -->
<script src="brain-integration.js"></script>
<script>
// ? CONFIGURATION INTELLIGENTE AVEC IPs MULTIPLES
console.log('?? [Config] Syst�me multi-IP avec Alt+Ctrl+J');

// Configuration des IPs disponibles (incluant UQAM pour Podio)
const AVAILABLE_IPS = []; // Pas d'IPs par d�faut - utiliser Alt+Ctrl+J pour configurer

// V�rifier si une IP est d�j� configur�e, sinon utiliser la premi�re disponible
setTimeout(function() {
    var storedIp = localStorage.getItem('vitrine.backend.ip');
    
    if (storedIp) {
        console.log('? [Config] IP existante trouv�e:', storedIp);
        
        // S'assurer que le BACKEND_BASE est bien configur� au chargement
        if (typeof window !== 'undefined') {
            window.BACKEND_BASE = 'http://' + storedIp + ':7070';
        }
    } else {
        console.log('?? [Config] Aucune IP configur�e. Utilisez Alt+Ctrl+J pour configurer le backend.');
    }
}, 100);

// Info pour l'utilisateur
console.log('?? [Info] Utilisez Alt+Ctrl+J pour configurer l\'adresse du backend');
console.log('   Exemples: localhost, votre-ip-locale, SAV-ATL-POR-8.ddns.uqam.ca');
console.log('   Pour conna�tre votre IP locale: ipconfig (Windows) ou ifconfig (Linux/Mac)');
</script>
<!-- Tout le JavaScript a �t� d�plac� dans app.js -->
<!-- Syst�me d'appel WebRTC -->
<!-- call.js SUPPRIMÉ - Vitrine ne fait plus d'appels -->

<script>
// === Module Recherche de C�blage ===
var graphSearchInitialized = false;
var graphSearchTimeout = null;

async function initGraphSearch() {
    if (graphSearchInitialized) return;
    var resultsDiv = document.getElementById('graphSearchResults');
    if (resultsDiv) {
        resultsDiv.innerHTML = '<div class="graph-loading"><i class="fas fa-spinner fa-spin"></i> Chargement du graphe...</div>';
    }
    try {
        var success = await GraphSearch.load();
        if (success) {
            graphSearchInitialized = true;
            updateGraphStats();
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div class="graph-placeholder"><i class="fas fa-project-diagram"></i><p>Entrez un code c�ble (ex: V001) ou un �quipement (ex: Extron)</p></div>';
            }
        } else {
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div class="graph-no-results"><i class="fas fa-exclamation-circle"></i><p>Impossible de charger le graphe de c�blage</p></div>';
            }
        }
    } catch (error) {
        console.error('[GraphUI] Erreur:', error);
        if (resultsDiv) {
            resultsDiv.innerHTML = '<div class="graph-no-results"><i class="fas fa-exclamation-circle"></i><p>Erreur: ' + error.message + '</p></div>';
        }
    }
}

function updateGraphStats() {
    var stats = GraphSearch.getStats();
    if (!stats) return;
    var statsDiv = document.getElementById('graphSearchStats');
    if (statsDiv) {
        statsDiv.classList.remove('hidden');
        document.getElementById('statNodes').textContent = stats.nodes;
        document.getElementById('statEdges').textContent = stats.edges;
        document.getElementById('statUncertain').textContent = stats.uncertain;
    }
}

function handleGraphSearch(event) {
    clearTimeout(graphSearchTimeout);
    if (event.key === 'Enter') { executeGraphSearch(); return; }
    graphSearchTimeout = setTimeout(function() { executeGraphSearch(); }, 300);
}

function executeGraphSearch() {
    if (!graphSearchInitialized) { initGraphSearch().then(function() { executeGraphSearch(); }); return; }
    var input = document.getElementById('graphSearchInput');
    var query = input ? input.value.trim() : '';
    var resultsDiv = document.getElementById('graphSearchResults');
    if (!resultsDiv) return;
    if (query.length < 1) {
        resultsDiv.innerHTML = '<div class="graph-placeholder"><i class="fas fa-project-diagram"></i><p>Entrez un code c�ble ou un �quipement</p></div>';
        return;
    }
    var results = GraphSearch.search(query);
    renderSearchResults(results, query);
}

function renderSearchResults(results, query) {
    var resultsDiv = document.getElementById('graphSearchResults');
    if (!resultsDiv) return;
    var total = results.cables.length + results.equipment.length;
    if (total === 0) {
        resultsDiv.innerHTML = '<div class="graph-no-results"><i class="fas fa-search"></i><p>Aucun r�sultat pour "' + escapeHtml(query) + '"</p></div>';
        return;
    }
    var html = '';
    if (results.cables.length > 0) {
        html += '<div class="results-section"><div class="results-section-title"><i class="fas fa-link"></i> C�BLES <span class="count">' + results.cables.length + '</span></div>';
        results.cables.forEach(function(cable) {
            var catClass = (cable.category || '').toLowerCase().replace(/[^a-z]/g, '');
            html += '<div class="cable-card" onclick="showCableDetails(\'' + cable.code + '\')">';
            html += '<div class="cable-card-header"><span class="cable-code">' + cable.code + '</span><span class="cable-category cat-' + catClass + '">' + (cable.category || 'N/A') + '</span></div>';
            html += '</div>';
        });
        html += '</div>';
    }
    if (results.equipment.length > 0) {
        html += '<div class="results-section"><div class="results-section-title"><i class="fas fa-cube"></i> �QUIPEMENTS <span class="count">' + results.equipment.length + '</span></div>';
        results.equipment.forEach(function(equip) {
            var marque = equip.marque || '';
            var modele = equip.modele || equip.label;
            var fonction = equip.fonction || '';
            html += '<div class="equipment-card" onclick="showEquipmentDetails(\'' + equip.id + '\')">';
            html += '<div class="equipment-card-header">';
            if (marque) html += '<span class="equipment-marque">' + escapeHtml(marque) + '</span>';
            html += '<span class="equipment-modele">' + escapeHtml(modele) + '</span>';
            html += '</div>';
            if (fonction) html += '<div class="equipment-fonction">' + escapeHtml(fonction) + '</div>';
            html += '<div class="equipment-connections"><span class="inbound"><i class="fas fa-arrow-left"></i> ' + equip.connections.inbound + ' entr�es</span>';
            html += '<span class="outbound"><i class="fas fa-arrow-right"></i> ' + equip.connections.outbound + ' sorties</span></div>';
            html += '</div>';
        });
        html += '</div>';
    }
    resultsDiv.innerHTML = html;
}

function showCableDetails(code) {
    var cable = GraphSearch.getCable(code);
    if (!cable) return;
    var resultsDiv = document.getElementById('graphSearchResults');
    var confClass = cable.confidence >= 0.8 ? 'confidence-high' : (cable.confidence >= 0.6 ? 'confidence-medium' : 'confidence-low');
    var fromLabel = cable.from.node ? cable.from.node.label : 'Inconnu';
    var toLabel = cable.to.node ? cable.to.node.label : 'Inconnu';
    var html = '<div class="cable-details"><div class="cable-details-header"><span class="cable-details-title"><i class="fas fa-link"></i> C�ble ' + code + '</span>';
    html += '<button class="cable-details-close" onclick="executeGraphSearch()"><i class="fas fa-times"></i></button></div>';
    html += '<div class="cable-diagram"><div class="diagram-node"><div class="diagram-node-label">' + escapeHtml(fromLabel) + '</div></div>';
    html += '<div class="diagram-edge"><div class="diagram-edge-line"></div><div class="diagram-edge-code">' + code + '</div></div>';
    html += '<div class="diagram-node"><div class="diagram-node-label">' + escapeHtml(toLabel) + '</div></div></div>';
    html += '<div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem;">';
    html += '<div><strong>Cat�gorie:</strong> ' + (cable.category || 'Non class�') + '</div>';
    html += '<div><strong>Confiance:</strong> <span class="confidence-badge ' + confClass + '">' + Math.round(cable.confidence * 100) + '%</span></div></div></div>';
    resultsDiv.innerHTML = html;
}

function showEquipmentDetails(nodeId) {
    console.log('[Modal] Ouverture pour:', nodeId);
    
    var modal = document.getElementById('equipmentModal');
    var title = document.getElementById('equipmentModalTitle');
    var body = document.getElementById('equipmentModalBody');
    
    if (!modal || !body) {
        console.error('Modal non trouve');
        return;
    }
    
    if (typeof GraphSearch !== 'undefined') {
        var stats = GraphSearch.getStats();
        if (!stats || stats.nodes === 0) {
            GraphSearch.load('A-1825');
        }
    }
    
    var equip = GraphSearch.getEquipment(nodeId);
    if (!equip) {
        console.error('Equipement non trouve:', nodeId);
        return;
    }
    
    var marque = equip.marque || 'Inconnu';
    var modele = equip.modele || equip.label || 'N/A';
    var fonction = equip.fonction || '';
    var ports = equip.ports || [];
    
    // Recuperer les cables connectes a cet equipement
    var cables = GraphSearch.getCablesForEquipment ? GraphSearch.getCablesForEquipment(nodeId) : [];
    
    var portsIN = ports.filter(function(p) { return p.type === 'IN'; });
    var portsOUT = ports.filter(function(p) { return p.type === 'OUT'; });
    
    if (title) {
        title.innerHTML = '<i class="fas fa-microchip"></i> ' + marque + ' ' + modele;
    }
    
    // Fonction pour trouver le cable connecte a un port
    function findCableForPort(portName, direction) {
        for (var i = 0; i < cables.length; i++) {
            var cable = cables[i];
            if (direction === 'IN' && cable.target === nodeId) {
                return cable.label || cable.id || '';
            }
            if (direction === 'OUT' && cable.source === nodeId) {
                return cable.label || cable.id || '';
            }
        }
        return '';
    }
    
    var html = '<div class="eq-visual-container">';
    html += '<div class="eq-block">';
    
    // Ports IN (bleu)
    html += '<div class="eq-ports eq-ports-in">';
    html += '<div class="eq-ports-label">ENTREES</div>';
    if (portsIN.length > 0) {
        for (var i = 0; i < portsIN.length; i++) {
            var port = portsIN[i];
            var cableCode = port.cable || findCableForPort(port.name, 'IN');
            html += '<div class="eq-port eq-port-in">';
            html += '<span class="eq-port-connector">&#9679;</span>';
            html += '<span class="eq-port-name">' + (port.name || '') + '</span>';
            if (cableCode) {
                html += '<span class="eq-port-cable">' + cableCode + '</span>';
            }
            html += '</div>';
        }
    } else {
        html += '<div class="eq-port-none">Aucune</div>';
    }
    html += '</div>';
    
    // Corps
    html += '<div class="eq-body">';
    html += '<div class="eq-brand">' + marque + '</div>';
    html += '<div class="eq-model">' + modele + '</div>';
    if (fonction) {
        html += '<div class="eq-function">' + fonction + '</div>';
    }
    html += '</div>';
    
    // Ports OUT (vert)
    html += '<div class="eq-ports eq-ports-out">';
    html += '<div class="eq-ports-label">SORTIES</div>';
    if (portsOUT.length > 0) {
        for (var j = 0; j < portsOUT.length; j++) {
            var portOut = portsOUT[j];
            var cableCodeOut = portOut.cable || findCableForPort(portOut.name, 'OUT');
            html += '<div class="eq-port eq-port-out">';
            if (cableCodeOut) {
                html += '<span class="eq-port-cable">' + cableCodeOut + '</span>';
            }
            html += '<span class="eq-port-name">' + (portOut.name || '') + '</span>';
            html += '<span class="eq-port-connector">&#9679;</span>';
            html += '</div>';
        }
    } else {
        html += '<div class="eq-port-none">Aucune</div>';
    }
    html += '</div>';
    
    html += '</div>';
    
    html += '<div class="eq-legend">';
    html += '<span class="eq-legend-item"><span class="eq-legend-dot eq-legend-in"></span> Entrees (IN)</span>';
    html += '<span class="eq-legend-item"><span class="eq-legend-dot eq-legend-out"></span> Sorties (OUT)</span>';
    html += '</div>';
    
    html += '</div>';
    
    body.innerHTML = html;
    modal.style.display = 'flex';
}

function closeEquipmentModal() {
    var modal = document.getElementById('equipmentModal');
    if (modal) modal.style.display = 'none';
}



function clearGraphSearch() {
    var input = document.getElementById('graphSearchInput');
    if (input) { input.value = ''; input.focus(); }
    var resultsDiv = document.getElementById('graphSearchResults');
    if (resultsDiv) resultsDiv.innerHTML = '<div class="graph-placeholder"><i class="fas fa-project-diagram"></i><p>Entrez un code c�ble ou un �quipement</p></div>';
}

function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Auto-init quand page technique ouverte
var _origOpenTech = window.openTechnicalMode;
if (typeof _origOpenTech === 'function') {
    window.openTechnicalMode = function() {
        _origOpenTech.apply(this, arguments);
        setTimeout(function() { if (typeof GraphSearch !== 'undefined') initGraphSearch(); }, 500);
    };
}
</script>

<!-- Modal Equipement Details -->
<div id="equipmentModal" class="equipment-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:10000; align-items:center; justify-content:center; background:rgba(0,0,0,0.6);">
    <div class="equipment-modal-overlay" onclick="closeEquipmentModal()" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;"></div>
    <div class="equipment-modal-content" style="position:relative; background:white; border-radius:12px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); max-width:900px; width:95%; max-height:90vh; min-width:800px; overflow:auto; z-index:2; padding:20px;">
        <div class="equipment-modal-header" style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f0f0f0; padding-bottom:15px; margin-bottom:15px;">
            <h3 id="equipmentModalTitle"><i class="fas fa-cube"></i> Equipement</h3>
            <button class="equipment-modal-close" onclick="closeEquipmentModal()" style="background:#e74c3c; color:white; border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-times"></i></button>
        </div>
        <div id="equipmentModalBody" class="equipment-modal-body">
        </div>
    </div>
</div>

</body>
</html> 














